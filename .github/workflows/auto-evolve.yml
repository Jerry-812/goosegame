name: auto-evolve

on:
  schedule:
    - cron: "0 9 * * *"
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: auto-evolve
  cancel-in-progress: true

jobs:
  evolve:
    runs-on: ${{ fromJson(vars.RUNNER_LABELS || '\"ubuntu-latest\"') }}
    env:
      LLM_ENDPOINT: ${{ secrets.LLM_ENDPOINT || vars.LLM_ENDPOINT }}
      LLM_API_KEY: ${{ secrets.LLM_API_KEY || vars.LLM_API_KEY }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: Install root deps
        run: npm ci

      - name: Install core deps
        run: npm --prefix goose-catch-main ci

      - name: Install Playwright browsers
        run: |
          for attempt in 1 2 3; do
            if npx playwright install --with-deps chromium; then
              exit 0
            fi
            echo "Playwright install failed (attempt $attempt). Retrying..."
            sleep $((attempt * 5))
          done
          exit 1

      - name: Build baseline
        run: npm run build

      - name: Start preview server (baseline)
        run: |
          mkdir -p artifacts
          npm run preview -- --host 0.0.0.0 --port 4173 > artifacts/preview-baseline.log 2>&1 &
          echo $! > artifacts/preview.pid

      - name: Wait for preview (baseline)
        run: node scripts/wait-for-ready.mjs --url http://127.0.0.1:4173 --timeout-ms 30000

      - name: Baseline eval (median of 3)
        run: |
          node scripts/eval_repeat.mjs \
            --url http://127.0.0.1:4173 \
            --runs 3 \
            --dist-dir goose-catch-main/dist \
            --screenshot-dir artifacts/screenshots/baseline \
            --output artifacts/baseline.json \
            --log artifacts/baseline.log

      - name: Stop preview server (baseline)
        if: always()
        run: |
          if [ -f artifacts/preview.pid ]; then
            kill "$(cat artifacts/preview.pid)" || true
            rm -f artifacts/preview.pid
          fi

      - name: Skip patch generation (missing endpoint)
        if: env.LLM_ENDPOINT == ''
        run: echo "LLM_ENDPOINT is empty, baseline-only run."

      - name: Fetch patch
        if: env.LLM_ENDPOINT != ''
        id: fetch_patch
        run: |
          node scripts/fetch_patch.mjs \
            --endpoint "$LLM_ENDPOINT" \
            --prompt-file .github/prompts/auto-evolve.md \
            --output artifacts/patch.diff
          if [ -s artifacts/patch.diff ]; then
            echo "has_patch=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_patch=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Guardrails
        if: steps.fetch_patch.outputs.has_patch == 'true'
        run: node scripts/guardrails.mjs artifacts/patch.diff

      - name: Apply patch
        if: steps.fetch_patch.outputs.has_patch == 'true'
        run: git apply artifacts/patch.diff

      - name: Build candidate
        if: steps.fetch_patch.outputs.has_patch == 'true'
        run: npm run build

      - name: Start preview server (candidate)
        if: steps.fetch_patch.outputs.has_patch == 'true'
        run: |
          npm run preview -- --host 0.0.0.0 --port 4173 > artifacts/preview-candidate.log 2>&1 &
          echo $! > artifacts/preview.pid

      - name: Wait for preview (candidate)
        if: steps.fetch_patch.outputs.has_patch == 'true'
        run: node scripts/wait-for-ready.mjs --url http://127.0.0.1:4173 --timeout-ms 30000

      - name: Candidate eval (median of 3)
        if: steps.fetch_patch.outputs.has_patch == 'true'
        run: |
          node scripts/eval_repeat.mjs \
            --url http://127.0.0.1:4173 \
            --runs 3 \
            --dist-dir goose-catch-main/dist \
            --screenshot-dir artifacts/screenshots/candidate \
            --output artifacts/candidate.json \
            --log artifacts/candidate.log

      - name: Stop preview server (candidate)
        if: always() && steps.fetch_patch.outputs.has_patch == 'true'
        run: |
          if [ -f artifacts/preview.pid ]; then
            kill "$(cat artifacts/preview.pid)" || true
            rm -f artifacts/preview.pid
          fi

      - name: Score
        if: steps.fetch_patch.outputs.has_patch == 'true'
        id: score
        run: |
          node scripts/score.mjs artifacts/baseline.json artifacts/candidate.json --output artifacts/score.json || true
          node - << 'NODE'
          const fs = require('node:fs');
          const out = process.env.GITHUB_OUTPUT;
          const data = JSON.parse(fs.readFileSync('artifacts/score.json', 'utf8'));
          fs.appendFileSync(out, `improved=${String(Boolean(data.improved))}\n`);
          fs.appendFileSync(out, `baselineScore=${String(data.baselineScore ?? '')}\n`);
          fs.appendFileSync(out, `candidateScore=${String(data.candidateScore ?? '')}\n`);
          NODE

      - name: Create pull request
        if: steps.score.outputs.improved == 'true'
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          branch: auto/evolve
          delete-branch: true
          title: "auto: improve game performance/stability"
          commit-message: "auto: optimize"
          body: |
            Automated patch from LLM endpoint.

            Score summary:
            - Baseline score: ${{ steps.score.outputs.baselineScore }}
            - Candidate score: ${{ steps.score.outputs.candidateScore }}

      - name: Enable auto-merge
        if: steps.cpr.outputs.pull-request-number != ''
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          pull-request-number: ${{ steps.cpr.outputs.pull-request-number }}
          merge-method: squash

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: auto-evolve-artifacts
          path: artifacts
          if-no-files-found: ignore

      - name: Final cleanup
        if: always()
        run: |
          if [ -f artifacts/preview.pid ]; then
            kill "$(cat artifacts/preview.pid)" || true
            rm -f artifacts/preview.pid
          fi
