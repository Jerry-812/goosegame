name: auto-evolve

on:
  schedule:
    - cron: "0 9 * * *"
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: write

jobs:
  evolve:
    runs-on: ${{ fromJson(vars.RUNNER_LABELS || '\"ubuntu-latest\"') }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: Install root deps
        run: npm ci

      - name: Install core deps
        run: npm --prefix goose-catch-main ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Build
        run: npm run build

      - name: Start preview server (baseline)
        run: |
          npm run preview -- --host 0.0.0.0 --port 4173 > preview-baseline.log 2>&1 &
          echo $! > preview.pid
          ready=0
          for i in {1..30}; do
            if curl -fsS http://127.0.0.1:4173/ >/dev/null; then
              ready=1
              break
            fi
            sleep 1
          done
          if [ "$ready" -ne 1 ]; then
            echo "Preview server not ready" >&2
            tail -n 200 preview-baseline.log || true
            exit 1
          fi

      - name: Baseline eval
        env:
          DIST_DIR: goose-catch-main/dist
          EVAL_RUNS: 3
        run: node scripts/eval.mjs http://127.0.0.1:4173 > baseline.json

      - name: Stop preview server (baseline)
        if: always()
        run: |
          if [ -f preview.pid ]; then
            kill $(cat preview.pid) || true
          fi

      - name: Upload baseline artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: baseline-artifacts
          path: |
            baseline.json
            preview-baseline.log
          if-no-files-found: ignore

      - name: Generate patch (LLM)
        id: generate
        env:
          LLM_ENDPOINT: ${{ secrets.LLM_ENDPOINT || vars.LLM_ENDPOINT }}
          LLM_API_KEY: ${{ secrets.LLM_API_KEY || vars.LLM_API_KEY }}
        run: |
          node scripts/agent_generate_patch.mjs baseline.json
          if [ -s agent.patch ]; then echo "has_patch=true" >> $GITHUB_OUTPUT; else echo "has_patch=false" >> $GITHUB_OUTPUT; fi

      - name: Guardrails
        if: steps.generate.outputs.has_patch == 'true'
        run: node --input-type=module -e "import {assertPatchSafe,readPatch} from './scripts/guardrails.mjs'; const p=readPatch('agent.patch'); assertPatchSafe(p); console.log('Patch safe');"

      - name: Apply patch
        if: steps.generate.outputs.has_patch == 'true'
        run: |
          git apply agent.patch
          git status --porcelain

      - name: Rebuild
        if: steps.generate.outputs.has_patch == 'true'
        run: npm run build

      - name: Start preview server (candidate)
        if: steps.generate.outputs.has_patch == 'true'
        run: |
          npm run preview -- --host 0.0.0.0 --port 4173 > preview-candidate.log 2>&1 &
          echo $! > preview.pid
          ready=0
          for i in {1..30}; do
            if curl -fsS http://127.0.0.1:4173/ >/dev/null; then
              ready=1
              break
            fi
            sleep 1
          done
          if [ "$ready" -ne 1 ]; then
            echo "Preview server not ready" >&2
            tail -n 200 preview-candidate.log || true
            exit 1
          fi

      - name: Candidate eval
        if: steps.generate.outputs.has_patch == 'true'
        env:
          DIST_DIR: goose-catch-main/dist
          EVAL_RUNS: 3
        run: node scripts/eval.mjs http://127.0.0.1:4173 > candidate.json

      - name: Stop preview server (candidate)
        if: always()
        run: |
          if [ -f preview.pid ]; then
            kill $(cat preview.pid) || true
          fi

      - name: Upload candidate artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: candidate-artifacts
          path: |
            candidate.json
            preview-candidate.log
            agent.patch
          if-no-files-found: ignore

      - name: Decide
        id: decision
        if: steps.generate.outputs.has_patch == 'true'
        run: |
          node --input-type=module - << 'NODE'
          import fs from "node:fs";
          import { betterThan, score } from "./scripts/score.mjs";
          const base = JSON.parse(fs.readFileSync("baseline.json","utf8"));
          const cand = JSON.parse(fs.readFileSync("candidate.json","utf8"));
          const ok = betterThan(cand, base);
          const reasons = [];
          if (cand.console_errors > 0) reasons.push("console_errors");
          if (cand.smoke_ok === false) reasons.push("smoke_failed");
          if (cand.load_ms > base.load_ms * 1.1) reasons.push("load_regression");
          if (cand.bundle_kb > base.bundle_kb * 1.05) reasons.push("bundle_regression");
          if (score(cand) <= score(base) + 1.0) reasons.push("score_not_improved");
          console.log("BASE SCORE:", score(base), base);
          console.log("CAND SCORE:", score(cand), cand);
          console.log("DECISION_REASON:", reasons.length ? reasons.join(",") : "improved");
          if (process.env.GITHUB_OUTPUT) {
            fs.appendFileSync(process.env.GITHUB_OUTPUT, `improved=${ok}\\n`);
          }
          if (!ok) {
            process.exit(1);
          }
          NODE

      - name: Cleanup metrics
        if: steps.generate.outputs.has_patch == 'true'
        run: rm -f baseline.json candidate.json agent.patch preview.pid decision.txt preview-baseline.log preview-candidate.log || true

      - name: Create Pull Request
        id: cpr
        if: steps.decision.outputs.improved == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          title: "auto: improve game performance/stability"
          commit-message: "auto: optimize"
          branch: "auto/evolve"
          delete-branch: true
          body: |
            Automated improvement cycle.
            Baseline/candidate metrics are available in the workflow logs.

      - name: Enable auto-merge
        if: steps.cpr.outputs.pull-request-number != ''
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          pull-request-number: ${{ steps.cpr.outputs.pull-request-number }}
          merge-method: squash
